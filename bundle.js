(()=>{"use strict";window.util={shuffle:e=>{let t,n=e.length,i=0;for(;n--;)i=Math.floor(Math.random()*(n+1)),t=e[n],e[n]=e[i],e[i]=t;return e},getGuid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),makeClickable:(e,t)=>{e.forEach((e=>{e.setAttribute("id","pic"+window.util.getGuid()),e.addEventListener("click",t)})),e=Array.from(e)},showMessage:e=>{const t=document.createElement("div");t.classList.add("error-message"),t.style="z-index: 3;",t.style.position="absolute",t.style.top="10px",t.style.left="50%",t.style.transform="translate(-50%)",t.style.width="max-content",t.style.padding="10px 40px",t.style.fontSize="18px",t.style.color="crimson",t.style.textTransform="none",t.textContent=e,t.style.backgroundColor=window.getComputedStyle(document.body).getPropertyValue("background-color"),document.body.insertAdjacentElement("afterbegin",t)},hideMessage:()=>{document.querySelector(".error-message").remove()}},(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector("#upload-file"),n=e.querySelector(".img-upload__overlay"),i=n.querySelector("#upload-cancel"),o=n.querySelector(".text__hashtags"),a=n.querySelector(".text__description"),d=document.querySelector("body"),s=n.querySelector(".effect-level__pin"),l=n.querySelector(".img-upload__preview > img"),r=document.querySelector(".pictures");window.main={uploadImageForm:e,uploadOpen:t,uploadedImage:n,uploadClose:i,hashtagInput:o,commentInput:a,body:d,effectPin:s,uploadedImagePreview:l,picturesSection:r,SUCCESS_STATUS:200,ESCAPE:"Escape",HttpRequestMethod:{GET:"GET",POST:"POST"}}})(),(()=>{let e=[];window.load={getData:(t,n,i)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{if(o.status===window.main.SUCCESS_STATUS){const t=o.response;return t.forEach((t=>e.push(t))),void n(t)}i(`Ошибка ${o.status}: ${o.statusText}`)})),o.addEventListener("error",(()=>{i("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{i(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o.open(window.main.HttpRequestMethod.GET,t),o.send()},posts:e}})(),window.thumbnails={getThumbnailPictures:()=>Array.from(document.querySelectorAll(".picture"))},window.debounce={debounce:e=>{let t=null;return function(...n){const i=n;t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...i)}),500)}}},(()=>{const e=document.querySelector(".img-filters"),t=e=>{for(;document.querySelector(".picture");)document.querySelector(".picture").remove();return window.render.renderPictures(e),e};let n;const i=e.querySelector("#filter-default"),o=e.querySelector("#filter-random"),a=e.querySelector("#filter-discussed"),d=window.debounce.debounce((()=>{e.querySelectorAll(".img-filters__button").forEach((e=>e.classList.remove("img-filters__button--active"))),i.classList.add("img-filters__button--active"),t(window.load.posts),window.util.makeClickable(window.thumbnails.getThumbnailPictures(),window.preview.onThumbnailPictureClick)})),s=window.debounce.debounce((()=>{e.querySelectorAll(".img-filters__button").forEach((e=>e.classList.remove("img-filters__button--active"))),o.classList.add("img-filters__button--active"),n=[],n=window.util.shuffle(window.picture.copyPosts).slice(0,10),t(n),window.util.makeClickable(window.thumbnails.getThumbnailPictures(),window.preview.onUpdatedThumbnailPictureClick),window.filter={updatedPosts:n}})),l=window.debounce.debounce((()=>{e.querySelectorAll(".img-filters__button").forEach((e=>e.classList.remove("img-filters__button--active"))),a.classList.add("img-filters__button--active"),n=[],n=window.picture.copyPosts.sort((function(e,t){return e.comments.length>t.comments.length?-1:e.comments.length<t.comments.length?1:0})),t(n),window.util.makeClickable(window.thumbnails.getThumbnailPictures(),window.preview.onUpdatedThumbnailPictureClick),window.filter={updatedPosts:n}}));window.filter={showFilters:()=>{e.classList.remove("img-filters--inactive"),i.addEventListener("click",d),o.addEventListener("click",s),a.addEventListener("click",l)}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social__comments"),n=e.querySelector(".big-picture__cancel"),i=e.querySelector(".comments-loader"),o=(n,o,a)=>{let d="";"IMG"===n.target.tagName?d=n.target.parentElement.getAttribute("id"):"A"===n.target.tagName&&(d=n.target.getAttribute("id"));const s=((e,t)=>{const n=document.querySelector("#"+e);return t.indexOf(n)})(d,a);e.querySelector(".big-picture__img > img").src=o[s].url,e.querySelector(".likes-count").textContent=o[s].likes,e.querySelector(".comments-count--all").textContent=o[s].comments.length,e.querySelector(".social__caption").textContent=o[s].description,(n=>{const o=t.querySelector(".social__comment").cloneNode(!0);for(;t.firstChild;)t.removeChild(t.firstChild);const a=(n,i,a,d)=>{for(let s=n;s<i;s++,d++)if(a[s]){const n=o.cloneNode(!0);n.querySelector("img").src=a[s].avatar,n.querySelector("img").alt=a[s].name,n.querySelector(".social__text").textContent=a[s].message,t.appendChild(n),a.indexOf(a[s])===a.length-1&&e.querySelector(".comments-loader").classList.add("hidden")}return e.querySelector(".comments-count--showed").textContent=t.children.length,d};a(0,5,n.comments);let d=5;i.addEventListener("click",(()=>{d=a(d,d+5,n.comments,d)}))})(o[s]),e.classList.remove("hidden"),window.main.body.classList.add("modal-open")},a=()=>{e.querySelector(".social__comment-count").classList.remove("hidden"),e.querySelector(".comments-loader").classList.remove("hidden"),e.classList.add("hidden"),window.main.body.classList.remove("modal-open"),n.removeEventListener("click",s),document.removeEventListener("keydown",d)},d=e=>{e.key===window.main.ESCAPE&&(e.preventDefault(),a())},s=()=>{a()};window.preview={onThumbnailPictureClick:e=>{o(e,window.load.posts,window.thumbnails.getThumbnailPictures()),n.addEventListener("click",s),document.addEventListener("keydown",d)},onUpdatedThumbnailPictureClick:e=>{o(e,window.filter.updatedPosts,window.thumbnails.getThumbnailPictures()),n.addEventListener("click",s),document.addEventListener("keydown",d)}}})(),(()=>{const e=document.querySelector("#picture").content;window.render={renderPictures:t=>{const n=document.createDocumentFragment();t.forEach((t=>{n.appendChild((t=>{const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n.addEventListener("click",window.preview.onThumbnailPictureClick),n})(t))})),window.main.picturesSection.appendChild(n)}}})(),window.load.getData("https://21.javascript.pages.academy/kekstagram/data",(e=>{const t=Object.assign([],window.load.posts);window.render.renderPictures(e),window.util.makeClickable(window.thumbnails.getThumbnailPictures(),window.preview.onThumbnailPictureClick),window.filter.showFilters(),window.picture={copyPosts:t}}),window.util.showMessage),window.validation={onHashtagInputInput:()=>{const e=window.main.hashtagInput.value.split(" ");if(""!==window.main.hashtagInput.value)for(let t=0;t<e.length;t++){const n=/^#[\w]*$/;if(n.test(e[t]),n.test(e[t]))if(e[t].length>20)window.main.hashtagInput.setCustomValidity("Удалите "+(e[t].length-20)+" симв.");else if(e[t].length<2&&e.length<=5)window.main.hashtagInput.setCustomValidity("Добавьте еще хотя бы "+(2-e[t].length)+" симв.");else if(e.length>5)window.main.hashtagInput.setCustomValidity("Укажите не более пяти хэштегов.");else if(t>0)for(let n=1;n<=t;n++)String(e[t]).toLowerCase()===String(e[t-n]).toLowerCase()&&window.main.hashtagInput.setCustomValidity("Хэштеги не должны повторяться.");else window.main.hashtagInput.setCustomValidity("");else window.main.hashtagInput.setCustomValidity("Хэштег должен начинаться с #, а затем состоять только из цифр или английских букв.")}else window.main.hashtagInput.setCustomValidity("");window.main.hashtagInput.reportValidity(),window.main.hashtagInput.validity.valid?window.main.hashtagInput.style="":(window.main.hashtagInput.style.border="2px solid red",window.main.hashtagInput.style.outlineOffset="2px")},onFormInputSubmit:e=>{window.main.hashtagInput.validity.valid&&window.main.commentInput.validity.valid||e.preventDefault()},onCommentInputInput:()=>{window.main.commentInput.value.length>140?(window.main.commentInput.setCustomValidity("Длина комментария не может составлять больше 140 символов."),window.main.commentInput.style.border="2px solid red",window.main.hashtagInput.style.outlineOffset="2px"):(window.main.commentInput.setCustomValidity(""),window.main.commentInput.style=""),window.main.commentInput.reportValidity()}},(()=>{const e=window.main.uploadedImage.querySelector(".scale__control--smaller"),t=window.main.uploadedImage.querySelector(".scale__control--bigger"),n=window.main.uploadedImage.querySelector(".scale__control--value");let i=Number(n.value.split("%")[0]);const o=()=>{window.main.uploadedImagePreview.style.transform=`scale(${i/100})`};window.scale={onScaleControlClick:a=>{a.target===t?i<100?i+=25:i=100:a.target===e&&(i>25?i-=25:i=25),n.value=i+"%",o()},setScaleToDefault:()=>{n.value="100%",i=100,o()}}})(),(()=>{const e=window.main.uploadedImage.querySelector(".effect-level"),t=e.querySelector(".effect-level__value"),n=e.querySelector(".effect-level__line"),i=e.querySelector(".effect-level__depth");let o=0;const a=()=>(t.value=Math.round(window.main.effectPin.offsetLeft/window.main.effectPin.offsetParent.offsetWidth*100),i.style.width=Number(t.value)+"%",Number(t.value)),d=()=>{t.value=100,window.main.uploadedImagePreview.classList.contains("effects__preview--^")||(window.main.uploadedImagePreview.style.filter=""),i.style.width="100%"};window.effect={effectLine:n,onEffectInputChange:t=>{t.target&&t.target.matches("input[type='radio']")&&(window.main.uploadedImagePreview.className="",d(),"none"!==t.target.value?(e.classList.remove("hidden"),o=n.offsetWidth,window.main.effectPin.style.left=o+"px",window.main.uploadedImagePreview.classList.add("effects__preview--"+t.target.value)):e.classList.add("hidden"))},onEffectPinMouseDown:t=>{t.preventDefault();let i=t.clientX;o=n.offsetWidth;const d=e=>{e.preventDefault();const t=i-e.clientX;i=e.clientX;let n=window.main.effectPin.offsetLeft-t;n>o?n=o:n<0&&(n=0),window.main.effectPin.style.left=n+"px",a(),window.main.uploadedImagePreview.classList.contains("effects__preview--chrome")?window.main.uploadedImagePreview.style.filter=`grayscale(${a()/100})`:window.main.uploadedImagePreview.classList.contains("effects__preview--sepia")?window.main.uploadedImagePreview.style.filter=`sepia(${a()/100})`:window.main.uploadedImagePreview.classList.contains("effects__preview--marvin")?window.main.uploadedImagePreview.style.filter=`invert(${a()}%)`:window.main.uploadedImagePreview.classList.contains("effects__preview--phobos")?window.main.uploadedImagePreview.style.filter=`blur(${3*a()/100}px)`:window.main.uploadedImagePreview.classList.contains("effects__preview--heat")&&(window.main.uploadedImagePreview.style.filter=`brightness(${1+.02*a()})`)},s=t=>{t.preventDefault(),e.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s)};e.addEventListener("mousemove",d),document.addEventListener("mouseup",s)},resetEffectLevel:d,setEffectToOriginal:()=>{window.main.uploadedImagePreview.className="",window.main.uploadedImage.querySelectorAll(".effects__radio").forEach((e=>{e.checked=!1})),window.main.uploadedImage.querySelector("#effect-none").checked=!0,e.classList.add("hidden")}}})(),window.upload={upload:(e,t,n)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{i.status!==window.main.SUCCESS_STATUS?n():t()})),i.open(window.main.HttpRequestMethod.POST,"https://21.javascript.pages.academy/kekstagram"),i.send(e)}},(()=>{const e=["image/png","image/jpeg","image/gif"],t=e=>{e.key===window.main.ESCAPE&&document.activeElement!==window.main.hashtagInput&&document.activeElement!==window.main.commentInput&&(e.preventDefault(),d())},n=e=>{const t=document.querySelector("#"+e).content.cloneNode(!0),n=document.createDocumentFragment();n.appendChild(t),document.querySelector("main").insertBefore(n,document.querySelector(".img-filters"));const i=()=>{document.querySelector("main").removeChild(document.querySelector("section."+e)),document.removeEventListener("click",a),document.removeEventListener("keydown",o)},o=e=>{e.key===window.main.ESCAPE&&(e.preventDefault(),i())},a=()=>{i()};document.querySelector(`.${e}__button`).addEventListener("click",a),document.addEventListener("click",a),document.addEventListener("keydown",o)},i=()=>{d(),n("success")},o=()=>{d(),n("error")},a=e=>{window.upload.upload(new FormData(window.main.uploadImageForm),i,o),e.preventDefault()},d=()=>{document.removeEventListener("keydown",t),window.main.uploadImageForm.removeEventListener("click",window.scale.onScaleControlClick),window.main.uploadedImage.removeEventListener("change",window.effect.onEffectInputChange),window.main.effectPin.removeEventListener("mousedown",window.effect.onEffectPinMouseDown),window.main.hashtagInput.removeEventListener("input",window.validation.onHashtagInputInput),window.main.hashtagInput.removeEventListener("submit",window.validation.onFormInputSubmit),window.main.commentInput.removeEventListener("input",window.validation.onCommentInputInput),window.scale.setScaleToDefault(),window.effect.resetEffectLevel(),window.effect.setEffectToOriginal(),window.main.hashtagInput.value="",window.main.commentInput.value="",window.main.uploadOpen.value="",window.main.uploadedImage.classList.add("hidden"),window.main.body.classList.remove("modal-open"),document.querySelector(".error-message")&&window.util.hideMessage()},s=()=>{d(),window.main.uploadClose.removeEventListener("click",s)};window.main.uploadOpen.addEventListener("change",(()=>{const n=window.main.uploadOpen.files[0],i=n.type,o=e.some((e=>i===e)),d=n.size/1048576;if(o&&d<=10){const e=new FileReader;e.addEventListener("load",(()=>{window.main.uploadedImagePreview.src=e.result;const n=`url(${e.result})`,i=window.main.uploadedImage.querySelectorAll(".effects__preview");Array.from(i).forEach((e=>{e.style.backgroundImage=n})),window.main.uploadedImage.classList.remove("hidden"),window.main.effectPin.style.left=window.effect.effectLine.offsetWidth+"px",window.main.body.classList.add("modal-open"),document.addEventListener("keydown",t),window.main.uploadImageForm.addEventListener("click",window.scale.onScaleControlClick),window.main.uploadedImage.addEventListener("change",window.effect.onEffectInputChange),window.main.effectPin.addEventListener("mousedown",window.effect.onEffectPinMouseDown),window.main.hashtagInput.addEventListener("input",window.validation.onHashtagInputInput),window.main.hashtagInput.addEventListener("submit",window.validation.onFormInputSubmit),window.main.commentInput.addEventListener("input",window.validation.onCommentInputInput),window.main.uploadImageForm.addEventListener("submit",a)})),e.readAsDataURL(n),e.addEventListener("error",(()=>{window.util.showMessage("Ошибка загрузки файла")})),e.addEventListener("abort",(()=>{window.util.showMessage("Время загрузки файла превысило 10 с")})),setTimeout((()=>{e.abort()}),1e4)}window.main.uploadClose.addEventListener("click",s)}))})()})();